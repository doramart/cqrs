<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Repository.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Repository.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var thunkify = require("thunkify");
var Emitter = require("events").EventEmitter;

/**
 * @class Repository
 * @param Actor
 * @param eventstore
 */
export default class Repository extends Emitter {

    constructor(Actor, eventstore) {
        this.__Actor = Actor;
        this.__getFromSnapShot = thunkify(eventstore.getFromSnapshot).bind(eventstore);
        this.__createSnapshot = thunkify(eventstore.createSnapshot).bind(eventstore);
        this.__cache = {}
    }

    /**
     * Create a Actor object.
     * @method *create
     * @memberof Repository.prototype
     * @param data {Object}
     * @returns {Actor}
     */
    *create(data) {

        let actor = new this.__Actor(data);
        let result = yield this.__getFromSnapShot(actor.id);
        let stream = result[1];

        yield this.__createSnapshot({
            streamId: actor.id,
            data: this.__Actor.toJSON(actor),
            revision: stream.lastRevision
        });

        this.__cache[actor.id] = actor;

        return actor;

    }


    /**
     * clear a actor from cache.
     * @method clear
     * @memberof Repository.prototype
     * @param id
     */
    clear(id) {
        delete this.__cache[id];
    }

    /**
     * get actor from cache.
     * @memberof Repository.prototype
     * @method getFromCache
     * @param id {String}
     * @returns {Actor}
     */
    getFromCache(id) {
        return this.__cache[id];
    }

    /**
     * get a actor
     * @method *get
     * @memberof Repository.prototype
     * @param id {String}
     * @return {Actor}
     */
    *get(id) {

        let actor, returnFun = function () {
            if(actor  &amp;&amp; actor.data.alive === false){
                return null;
            }else{
                return actor;
            }
        };

        if (actor = this.getFromCache(id)) {
            return returnFun();
        }


        let result = yield this.__getFromSnapShot(id);
        if (actor = this.getFromCache(id)) {
            return returnFun();
        }

        let snapshot = result[0];
        let stream = result[1];

        if (!snapshot) return;

        let snap = snapshot.data;

        actor = new this.__Actor(snap);

        let history = stream.events;

        let historyv = [];

        history.forEach(function (e) {
            historyv.push(e.payload);
        });

        actor.$$loadEvents(historyv);

        this.__cache[actor.id] = actor;

        return returnFun();
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AbstractActor.html">AbstractActor</a></li><li><a href="Actor.html">Actor</a></li><li><a href="ActorListener.html">ActorListener</a></li><li><a href="Domain.html">Domain</a></li><li><a href="DomainEvent.html">DomainEvent</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="Repository.html">Repository</a></li></ul><h3>Events</h3><ul><li><a href="AbstractActor.html#event:apply">apply</a></li><li><a href="AbstractActor.html#event:listen">listen</a></li><li><a href="AbstractActor.html#event:remove">remove</a></li><li><a href="Actor.html#event:apply">apply</a></li><li><a href="Actor.html#event:listen">listen</a></li><li><a href="Actor.html#event:remove">remove</a></li><li><a href="ActorListener.html#event:apply">apply</a></li><li><a href="ActorListener.html#event:listen">listen</a></li><li><a href="ActorListener.html#event:remove">remove</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta1</a> on Thu Mar 19 2015 09:44:59 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
