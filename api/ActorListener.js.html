<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ActorListener.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ActorListener.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Actor = require("./Actor"), _ = require("underscore");

/**
 * Only cqrs container use it.
 * @class ActorListener
 * @extends Actor
 */
class ActorListener extends Actor {

    constructor() {
        super({id: 'ActorListenerId', repos: {}});
    }

    /**
     * type is ActorListener
     * @member ActorListener#type
     * @see AbstractActor#type
     */
    static get type() {
        return "ActorListener"
    }

    /**
     * Listen a actor's domain event.
     * @memberof ActorListener.prototype
     * @method listen
     * @param eventName
     * @param actor
     * @param handle
     * @param isOne
     */
    listen(eventName, actor, handle, isOne) {
        let actorType = actor.type;
        let actorId = actor.id;
        let param = {eventName, actorType, actorId, handle, isOne};
        this._apply("listen", param);
    }

    /**
     * Listen once a actor's domain event.
     * @memberof ActorListener.prototype
     * @method listenOne
     * @see ActorListener#listen
     */
    listenOne() {
        var args = _.toArray(arguments);
        args[3] = true;
        this.listen.apply(this,args);
    }

    /**
     * publish domain'event. when have event's listener , then call the listener's handle method.
     * the listener is a actor object.
     * @memberof ActorListener.prototype
     * @method pub
     * @param event {DomainEvent} domain event
     */
    pub(event) {

        var list = this._data.repos[event.name] || [];

        list.forEach(listener=> {
            this.myDomain.get(listener.actorType, listener.actorId, function (err, actor) {
                if (actor &amp;&amp; actor[listener.handle])
                    actor[listener.handle](event);
            });
        });

        this._apply("emit", event.name);
    }

    _when(event) {

        var repos = this._data.repos;
        if (event.name === "listen") {


            let eventName = event.data.eventName;
            let repo;
            repo = (repo = repos[eventName]) ? repos[eventName] : (repos[eventName] = []);
            repo.push(event.data);

        } else if (event.name === "emit") {

            var list = repos[event.data] || [];

            for (var i = 0, len = list.length; i &lt; len; i++) {
                let listener = list[i];
                if (listener.isOne) {
                    list[i] = null;
                }
            }
            repos[event.data] = _.compact(list);
        }

    }

}

module.exports = ActorListener;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AbstractActor.html">AbstractActor</a></li><li><a href="Actor.html">Actor</a></li><li><a href="ActorListener.html">ActorListener</a></li><li><a href="Domain.html">Domain</a></li><li><a href="DomainEvent.html">DomainEvent</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="Repository.html">Repository</a></li></ul><h3>Events</h3><ul><li><a href="AbstractActor.html#event:apply">apply</a></li><li><a href="AbstractActor.html#event:listen">listen</a></li><li><a href="AbstractActor.html#event:remove">remove</a></li><li><a href="Actor.html#event:apply">apply</a></li><li><a href="Actor.html#event:listen">listen</a></li><li><a href="Actor.html#event:remove">remove</a></li><li><a href="ActorListener.html#event:apply">apply</a></li><li><a href="ActorListener.html#event:listen">listen</a></li><li><a href="ActorListener.html#event:remove">remove</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta1</a> on Thu Mar 19 2015 09:44:59 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
